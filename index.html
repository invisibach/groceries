<html>

    <head>
        <link type="text/css" rel="stylesheet" href="./groceries.css" />
        <link type="text/css" rel="stylesheet" href="./modules/jqwidgets-9.1.4/styles/jqx.base.css" />
        <script type="text/javascript" src="./modules/papaparse/papaparse.min.js"></script>
        <script type="text/javascript" src="./modules/jquery/jquery-3.6.0.min.js"></script>
        <script src="./modules/jqwidgets-9.1.4/jqx-all.js"></script>
        <script src="./modules/jqwidgets-9.1.4/demos.js"></script>
    </head>




    <script>
        let recipes = {}
        let ingredientsDict = {}
        function initDatabase(_callback) {
            Papa.parse('https://docs.google.com/spreadsheets/d/e/2PACX-1vS7rW-SfDDquABsjSutO8YlDOzyM8kTgSVkuAGbXZ6j1JpsFUaUgBaxgrS8BV80_xG-oVb1t9p5Bcq5/pub?output=csv', {
                download: true,
                header: true,
                complete: function(results) {
                    var recipelines = results.data

                    for (var r=0; r<recipelines.length; r++){
                        //split recipes from ingredients
                        if(recipelines[r].ingredients !== ""){
                            if (recipelines[r].dish !== ""){
                                recipes[recipelines[r].dish] = {
                                    "cuisine": recipelines[r].cuisine,
                                    "time": recipelines[r].time,
                                    "meal": recipelines[r].meal.split(","),
                                    "ingredients": new Array()
                                }
                            } else {
                                recipelines[r].dish = recipelines[r-1].dish
                            }
                            recipes[recipelines[r].dish]['ingredients'].push(
                                {
                                    "ingredient": recipelines[r].ingredients,
                                    "quantity": parseFloat(recipelines[r].quantity)
                                }
                            )
                        }
                        if(recipelines[r]['ingredient-name'] !== ""){
                            ingredientsDict[recipelines[r]['ingredient-name']] = {
                                "type": recipelines[r].type,
                                "protein": recipelines[r].protein,
                                "measurement": recipelines[r].measurement,
                                "store": recipelines[r].store,
                                "isle": recipelines[r].isle,
                                "have": recipelines[r].have
                            }
                        }
                    }
                _callback()
                }
            })
        }
        
        function findByMatchingProperties(set, properties) {
            return set.filter(function (entry) {
                return Object.keys(properties).every(function (key) {
                    return entry[key] === properties[key];
                });
            });
        }

        function collectIngredientList(){
            var mealplan = [].concat($("#lunch_kanban").jqxKanban('getItems'), $("#dinner_kanban").jqxKanban('getItems'), $("#p_breakfast_kanban").jqxKanban('getItems'), $("#p_snack_kanban").jqxKanban('getItems'), $("#p_lunch_kanban").jqxKanban('getItems'))
            var mealnames = []
            var mealIngredientsList = []
            for (var m in mealplan){
                mealnames.push(mealplan[m].text)
            }
            for (var n in mealnames){
                for (var i in recipes[mealnames[n]].ingredients){
                    var thisIngredient = recipes[mealnames[n]].ingredients[i]
                    // check if ingredient already in list
                    var index = mealIngredientsList.findIndex(function(ing) {
                        return ing.ingredient == thisIngredient.ingredient
                    });
                    // increase quantity if already in list, add to list if not
                    if (index > -1){
                        mealIngredientsList[index].quantity += thisIngredient.quantity
                    } else {
                        thisIngredient.measurement = ingredientsDict[thisIngredient.ingredient].measurement
                        thisIngredient.store = ingredientsDict[thisIngredient.ingredient].store,
                        thisIngredient.isle = ingredientsDict[thisIngredient.ingredient].isle,
                        thisIngredient.have = ingredientsDict[thisIngredient.ingredient].have
                        mealIngredientsList.push(thisIngredient)
                    }
                }
            }
            formattedMealIngredientsList = textFormat(mealIngredientsList)

            return formattedMealIngredientsList
        }

        function textFormat(list){
            var formattedDict = {}
            for(var i in list){
                if(list[i].store in formattedDict){
                    if (list[i].isle in formattedDict[list[i].store]){
                        formattedDict[list[i].store][list[i].isle].push(list[i])
                    } else {
                        formattedDict[list[i].store][list[i].isle] = [list[i]]
                    }
                } else {
                    formattedDict[list[i].store] = {}
                    formattedDict[list[i].store][list[i].isle] = [list[i]]
                }
            }
            
            console.log("ðŸš€ ~ file: index.html ~ line 102 ~ textFormat ~ formattedDict", formattedDict)
            
            var formattedString = ""
            for (var s in formattedDict){
                //add store name
                formattedString += "<div style='text-align: left;''><span style='font-weight: bold; font-size: medium;'>" + s + "</span></div><ul>"
                for (var i in formattedDict[s]){
                    //add isle name
                    formattedString += "<li>" + i + "<br></li><ul>"
                        for (var f=0; f<formattedDict[s][i].length; f++){
                            var slIng = formattedDict[s][i][f]
                            formattedString += ["<li>",slIng.ingredient, "||", slIng.quantity, slIng.measurement, "</li>"].join(" ")
                        }
                    formattedString += "</ul>"
                    // formattedString += "</ul>"
                }
                formattedString += "</ul><div><br></div>"
            }

            return formattedString
        }



        
        $(document).ready(function () {
            initDatabase(function() {

                // var proteinArray = [{ id: 0, name: "Soylent Green", image: "./images/common.png", common: true }]
                var proteinArray = []
                for (var i in ingredientsDict){
                    if (ingredientsDict[i].type == "meat"){
                        if (findByMatchingProperties(proteinArray, {name: ingredientsDict[i].protein})){
                            proteinArray.push({
                                id: proteinArray.length,
                                name: ingredientsDict[i].protein,
                                image: "./images/" + ingredientsDict[i].protein + ".png"
                            })
                        }
                    }
                }
                // build cuisinecolumns from spreadsheet database                
                var cuisineColumns = []
                for (var r in recipes){
                    if (findByMatchingProperties(cuisineColumns, {text: recipes[r].cuisine}) < 1){
                        cuisineColumns.push({
                            text: recipes[r].cuisine,
                            dataField: recipes[r].cuisine
                        })
                    }
                }

                var dayColumns = [
                    { text: "Sunday", dataField: "sun", maxItems: 3, collapsible: false },
                    { text: "Monday", dataField: "mon", maxItems: 3, collapsible: false },
                    { text: "Tuesday", dataField: "tue", maxItems: 3, collapsible: false },
                    { text: "Wednesday", dataField: "wed", maxItems: 3, collapsible: false },
                    { text: "Thursday", dataField: "thu", maxItems: 3, collapsible: false },
                    { text: "Friday", dataField: "fri", maxItems: 3, collapsible: false },
                    { text: "Saturday", dataField: "sat", maxItems: 3, collapsible: false }
                ];
            
                //build meals from speadsheet database
                var allMealsSource = []
                var recipenames = Object.keys(recipes)
                for (var r=0; r< recipenames.length; r++){
                    // var proteinID = -1

                    for(var i in recipes[recipenames[r]].ingredients){
                        var proteinLookup  = findByMatchingProperties(proteinArray, {name:ingredientsDict[recipes[recipenames[r]].ingredients[i].ingredient].protein})
                        if(proteinLookup.length > 0){
                            proteinID = proteinLookup[0].id
                        }
                    }

                    allMealsSource.push({
                        id: r,
                        status: recipes[recipenames[r]].cuisine,
                        text: recipenames[r],
                        tags: recipes[recipenames[r]].meal.join(),
                        color: "#5dc3f0",
                        resourceId: proteinID
                    })
                }

                var kanbanSourceConnected2 = [];
                var kanbanSourceConnected3 = [];
                var kanbanSourceConnected4 = [];
                var kanbanSourceConnected5 = [];
                var kanbanSourceConnected6 = [];
    
    
                var recipeTemplate = "<div class='jqx-kanban-item' id=''>"
                        + "<div class='jqx-kanban-item-color-status'></div>"
                        + "<div class='jqx-kanban-item-avatar'></div>"
                        // + "<div class='jqx-icon jqx-icon-close jqx-kanban-item-template-content jqx-kanban-template-icon'></div>"
                        + "<div class='jqx-kanban-item-text'></div>"
                        + "<div style='display: none;' class='jqx-kanban-item-footer'></div>"
                        + "</div>"

                $('#allMeals_kanban').jqxKanban({
                    itemRenderer: function(element, item, resource)
                    {
                        $(element).find(".jqx-kanban-item-text").css('background', item.color);
                    },                    
                    width: '100%',
                    height: 400,
                    template: recipeTemplate,
                    source: allMealsSource,
                    connectWith: "#dinner_kanban, #lunch_kanban, #p_breakfast_kanban, #p_snack_kanban, #p_lunch_kanban",
                    columns: cuisineColumns,
                    resources: proteinArray,
                    headerHeight: 20
                });
                $('#dinner_kanban').jqxKanban({
                    width: '100%',
                    height: 155,
                    template: recipeTemplate,
                    source: kanbanSourceConnected2,
                    connectWith: "#allMeals_kanban, #lunch_kanban, #p_breakfast_kanban, #p_snack_kanban, #p_lunch_kanban",
                    columns: dayColumns,
                    resources: proteinArray,
                    headerHeight: 20
                });
                $('#lunch_kanban').jqxKanban({
                    width: '100%',
                    height: 155,
                    template: recipeTemplate,
                    source: kanbanSourceConnected3,
                    connectWith: "#allMeals_kanban, #dinner_kanban, #p_breakfast_kanban, #p_snack_kanban, #p_lunch_kanban",
                    columns: dayColumns,
                    resources: proteinArray,
                    headerHeight: 20
                });
                $('#p_breakfast_kanban').jqxKanban({
                    width: '100%',
                    height: 72,
                    template: recipeTemplate,
                    source: kanbanSourceConnected3,
                    connectWith: "#allMeals_kanban, #dinner_kanban, #lunch_kanban, #p_snack_kanban, #p_lunch_kanban",
                    columns: dayColumns,
                    resources: proteinArray,
                    headerHeight: 20
                });
                $('#p_snack_kanban').jqxKanban({
                    width: '100%',
                    height: 52,
                    template: recipeTemplate,
                    source: kanbanSourceConnected3,
                    connectWith: "#allMeals_kanban, #dinner_kanban, #lunch_kanban, #p_breakfast_kanban, #p_lunch_kanban",
                    columns: dayColumns,
                    resources: proteinArray,
                    headerHeight: 0
                });
                $('#p_lunch_kanban').jqxKanban({
                    width: '100%',
                    height: 52,
                    template: recipeTemplate,
                    source: kanbanSourceConnected3,
                    connectWith: "#allMeals_kanban, #dinner_kanban, #lunch_kanban, #p_breakfast_kanban, #p_snack_kanban",
                    columns: dayColumns,
                    resources: proteinArray,
                    headerHeight: 0
                });

                $("#verticalSplitter").jqxSplitter({
                    width: '100%',
                    // $(window).height() - 128
                    height: 'calc(100% - 2px)',
                    resizable: false,
                    panels: [{
                        size: '100%',
                        collapsible: false
                    }, {
                        size: 384,
                        min: 384
                    }]
                });
                $("#horizontalSplitter").jqxSplitter({
                    width: '100%',
                    // $(window).height() - 128
                    height: '100%',
                    resizable: false,
                    orientation: 'horizontal',
                    panels: [{
                        size: '100%',
                        collapsible: false
                    }, {
                        size: 490,
                        min: 490
                    }]
                });

                $(document).ready(function () {
                    $('#shoppingList').jqxEditor({
                        width: "100%",
                        height: "100%",
                        tools: 'bold italic underline | size | color | left center right | outdent indent | ul ol | clean'
                    });
                });


                //
                // EVENTS
                //

                //trigger on meal move
                $("[id$=kanban]").on('itemMoved', function (event) {
                    setTimeout(function() {
                        var currentIngredientList = collectIngredientList()
                        $("#shoppingList").val(currentIngredientList)
                    }, 10);
                });


                //basis for leftover duplication
                $('#allMeals_kanban').on("itemAttrClicked", function (event) {
                    var args = event.args;
                    if (args.attribute == "template") {
                        $('#allMeals_kanban').jqxKanban('removeItem', args.item.id);
                    }
                });
            });
        });
    </script>
</head>
<body>
    <div id="verticalSplitter">
        <div style="overflow-y: auto;">
            <div id="horizontalSplitter">
                <div id="allMeals_kanban" style="float:left"></div>
                <div>
                    <div id="dinner_kanban"></div>
                    <div id="lunch_kanban"></div>
                    <div id="p_breakfast_kanban"></div>
                    <div id="p_snack_kanban"></div>
                    <div id="p_lunch_kanban"></div>

                </div>

            </div>
        </div>



        <div style="overflow-y: auto;">
            <textarea name="shoppingList" id="shoppingList" style="float: right"></textarea>
        </div>
    </div>

</body>

</html>